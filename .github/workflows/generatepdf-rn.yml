name: Generate PDF RN with Cover

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: "ì œí’ˆëª… (ì˜ˆ: BioStar 2)"
        required: true
        default: "BioStar 2"
      version:
        description: "ë²„ì „ (ì˜ˆ: 2.9.11@pdf, 2.9.12@pdf)"
        required: true
        default: "2.9.11@pdf"
      date:
        description: "ë¦´ë¦¬ìŠ¤ ë‚ ì§œ"
        required: true
        default: "YYMMDD"

permissions:
  contents: write

env:
  PRINCE_VER: 16

jobs:
  build-n-deploy:
    name: Generate PDF
    runs-on: macos-14
    timeout-minutes: 30  # ì›Œí¬í”Œë¡œìš° íƒ€ì„ì•„ì›ƒ ì„¤ì •
    steps:
    - uses: actions/checkout@v4

    - name: Print Input
      run: |
        echo "===ì›Œí¬í”Œë¡œìš° ì…ë ¥ê°’==="
        echo "Input ì œí’ˆëª…: ${{ github.event.inputs.product_name }}"
        echo "Input ë²„ì „: ${{ github.event.inputs.version }}"
        echo "Input ë¦´ë¦¬ìŠ¤ ë‚ ì§œ: ${{ github.event.inputs.date }}"

    - name: Install Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Install PrinceXML
      run: |
        echo "ğŸ“¦ Prince XML ì„¤ì¹˜ ì¤‘..."
        # ìºì‹œ ë””ë ‰í† ë¦¬ ì„¤ì •
        CACHE_DIR="$HOME/.cache/prince"
        PRINCE_FILE="prince-${{ env.PRINCE_VER }}-macos.zip"
        
        mkdir -p "$CACHE_DIR"
        
        # ìºì‹œëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
        if [ ! -f "$CACHE_DIR/$PRINCE_FILE" ]; then
          echo "Prince XML ë‹¤ìš´ë¡œë“œ ì¤‘..."
          curl -L "https://www.princexml.com/download/$PRINCE_FILE" -o "$CACHE_DIR/$PRINCE_FILE"
        else
          echo "ìºì‹œëœ Prince XML ì‚¬ìš©"
        fi
        
        # ì••ì¶• í•´ì œ ë° ì„¤ì¹˜
        cd "$CACHE_DIR"
        tar zxf "$PRINCE_FILE"
        cd "prince-${{ env.PRINCE_VER }}-macos"
        yes "" | sudo ./install.sh
        echo "âœ… Prince XML ì„¤ì¹˜ ì™„ë£Œ"

    - name: Install other tools
      run: |
        echo "ğŸ“¦ ê¸°íƒ€ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."
        # Homebrew ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆë›°ì–´ ì‹œê°„ ë‹¨ì¶•
        export HOMEBREW_NO_AUTO_UPDATE=1
        
        echo "ğŸ“¦ ë„êµ¬ ì„¤ì¹˜ ì¤‘: pdfcpu, pdftk-java, gh"
        brew install pdfcpu pdftk-java gh

        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"
    
    - name: Setup environment variables
      run: |
        echo "ğŸ“Š í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
        EN_NAME="BioStar_2_RevisionNotes_${{ github.event.inputs.version }}_EN_${{ github.event.inputs.date }}"
        KO_NAME="BioStar_2_RevisionNotes_${{ github.event.inputs.version }}_KO_${{ github.event.inputs.date }}"
        TAG_NAME="v${{ github.event.inputs.version }}"

        # í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
        echo "EN_NAME=${EN_NAME}" >> $GITHUB_ENV
        echo "KO_NAME=${KO_NAME}" >> $GITHUB_ENV
        echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV

        echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"
        echo "ì˜ë¬¸ íŒŒì¼ëª…: ${EN_NAME}"
        echo "í•œê¸€ íŒŒì¼ëª…: ${KO_NAME}"
        echo "íƒœê·¸ ë° ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸: ${TAG_NAME}"

    - name: Create PDF output directory
      run: mkdir -p ./pdf

    - name: Build Release Notes Korean PDF
      run: |
        echo "ğŸ“„ í•œêµ­ì–´ PDF ìƒì„± ë° ì²˜ë¦¬ ì‹œì‘..."

        echo "ğŸ“„ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì¤‘..."
        if ! node generate-cover-local.js \
          --title="BioStar 2" \
          --subtitle="RN" \
          --version="${{ github.event.inputs.version }}" \
          --lang="í•œêµ­ì–´" \
          --number="301.00.BS2" \
          --output="./pdf/front-cover-ko.html"; then
          echo "âŒ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
          
        echo "í”„ë¡ íŠ¸ ì»¤ë²„ PDF ë³€í™˜"
        if ! prince "./pdf/front-cover-ko.html" -o "./pdf/front-cover-ko.pdf"; then
          echo "âŒ í”„ë¡ íŠ¸ ì»¤ë²„ PDF ë³€í™˜ ì‹¤íŒ¨"
          exit 1
        fi
        pdfcpu annot remove "./pdf/front-cover-ko.pdf" || true

        echo "ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ í˜ì´ì§€ PDF ìƒì„± ì¤‘..."
        if ! node generatepdf \
          -u "https://supremainc.github.io/biostar2-docs/revision" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${KO_NAME}_temp.pdf" --include-index; then
          echo "âŒ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ PDF ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        pdfcpu annot remove -pages 1 "./pdf/${KO_NAME}_temp.pdf" || true

        echo "í”„ë¡ íŠ¸ ì»¤ë²„ì™€ ë©”ì¸ í˜ì´ì§€ ë³‘í•© ì¤‘..."
        if ! pdftk "./pdf/front-cover-ko.pdf" "./pdf/${KO_NAME}_temp.pdf" "./back-cover.pdf" cat output "./pdf/${KO_NAME}.pdf"; then
          echo "âŒ PDF ë³‘í•© ì‹¤íŒ¨"
          exit 1
        fi

        pdfcpu pagemode set "./pdf/${KO_NAME}.pdf" UseOutlines
        pdfcpu pagelayout set "./pdf/${KO_NAME}.pdf" SinglePage
        pdfcpu viewerpref set "./pdf/${KO_NAME}.pdf" '{"FitWindow": true, "CenterWindow": true}'
        echo "âœ… í•œêµ­ì–´ PDF ìƒì„± ì™„ë£Œ: ${KO_NAME}.pdf"

    - name: Build Release Notes English PDF
      run: |
        echo "ğŸ“„ ì˜ì–´ PDF ìƒì„± ë° ì²˜ë¦¬ ì‹œì‘..."

        echo "ğŸ“„ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì¤‘..."
        if ! node generate-cover-local.js \
          --title="BioStar 2" \
          --subtitle="RN" \
          --version="${{ github.event.inputs.version }}" \
          --lang="English" \
          --number="301.00.BS2" \
          --output="./pdf/front-cover-en.html"; then
          echo "âŒ í”„ë¡ íŠ¸ ì»¤ë²„ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
          
        echo "í”„ë¡ íŠ¸ ì»¤ë²„ PDF ë³€í™˜"
        if ! prince "./pdf/front-cover-en.html" -o "./pdf/front-cover-en.pdf"; then
          echo "âŒ í”„ë¡ íŠ¸ ì»¤ë²„ PDF ë³€í™˜ ì‹¤íŒ¨"
          exit 1
        fi
        pdfcpu annot remove "./pdf/front-cover-en.pdf" || true

        echo "ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ í˜ì´ì§€ PDF ìƒì„± ì¤‘..."
        if ! node generatepdf \
          -u "https://supremainc.github.io/biostar2-docs/en/revision" \
          --prince-args="--page-size='a4' --style=./print.css --javascript" \
          -o "./pdf/${EN_NAME}_temp.pdf" --include-index; then
          echo "âŒ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ PDF ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        pdfcpu annot remove -pages 1 "./pdf/${EN_NAME}_temp.pdf" || true

        echo "í”„ë¡ íŠ¸ ì»¤ë²„ì™€ ë©”ì¸ í˜ì´ì§€ ë³‘í•© ì¤‘..."
        if ! pdftk "./pdf/front-cover-en.pdf" "./pdf/${EN_NAME}_temp.pdf" "./back-cover-en.pdf" cat output "./pdf/${EN_NAME}.pdf"; then
          echo "âŒ PDF ë³‘í•© ì‹¤íŒ¨"
          exit 1
        fi
        
        pdfcpu pagemode set "./pdf/${EN_NAME}.pdf" UseOutlines
        pdfcpu pagelayout set "./pdf/${EN_NAME}.pdf" SinglePage
        pdfcpu viewerpref set "./pdf/${EN_NAME}.pdf" '{"FitWindow": true, "CenterWindow": true}'
        echo "âœ… ì˜ì–´ PDF ìƒì„± ì™„ë£Œ: ${EN_NAME}.pdf"

    - name: Verify Generated PDFs
      run: |
        echo "ğŸ“‹ ìƒì„±ëœ PDF íŒŒì¼ ê²€ì¦ ì¤‘..."
        
        # íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "./pdf/${KO_NAME}.pdf" ]; then
          echo "âŒ í•œêµ­ì–´ PDF íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ${KO_NAME}.pdf"
          exit 1
        fi
        
        if [ ! -f "./pdf/${EN_NAME}.pdf" ]; then
          echo "âŒ ì˜ì–´ PDF íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ${EN_NAME}.pdf"
          exit 1
        fi
        
        # íŒŒì¼ í¬ê¸° í™•ì¸ (ìµœì†Œ 10KB)
        KO_SIZE=$(stat -c%s "./pdf/${KO_NAME}.pdf" 2>/dev/null || stat -f%z "./pdf/${KO_NAME}.pdf")
        EN_SIZE=$(stat -c%s "./pdf/${EN_NAME}.pdf" 2>/dev/null || stat -f%z "./pdf/${EN_NAME}.pdf")
        
        if [ "$KO_SIZE" -lt 10240 ]; then
          echo "âŒ í•œêµ­ì–´ PDF íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤ (${KO_SIZE} bytes)"
          exit 1
        fi
        
        if [ "$EN_SIZE" -lt 10240 ]; then
          echo "âŒ ì˜ì–´ PDF íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤ (${EN_SIZE} bytes)"
          exit 1
        fi
        
        echo "âœ… PDF íŒŒì¼ ê²€ì¦ ì™„ë£Œ"
        echo "   - í•œêµ­ì–´ PDF: ${KO_NAME}.pdf ($(numfmt --to=iec $KO_SIZE))"
        echo "   - ì˜ì–´ PDF: ${EN_NAME}.pdf ($(numfmt --to=iec $EN_SIZE))"

    - name: Check and prepare release
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ—‘ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ë° íƒœê·¸ ì •ë¦¬ ì¤‘: ${TAG_NAME}"
        # ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì‹œë„ (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
        for i in {1..3}; do
          if gh release delete "${TAG_NAME}" -y 2>/dev/null; then
            echo "âœ… ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì™„ë£Œ (ì‹œë„ $i/3)"
            break
          else
            if [ $i -eq 3 ]; then
              echo "â„¹ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì—†ìŒ ë˜ëŠ” ì‚­ì œ ì‹¤íŒ¨ (ìµœì¢…)"
            else
              echo "â³ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì¬ì‹œë„ ì¤‘... ($i/3)"
              sleep 2
            fi
          fi
        done
        
        # ê¸°ì¡´ íƒœê·¸ ì‚­ì œ ì‹œë„
        git push origin --delete "${TAG_NAME}" 2>/dev/null || echo "â„¹ï¸ ê¸°ì¡´ íƒœê·¸ ì—†ìŒ ë˜ëŠ” ì‚­ì œ ì‹¤íŒ¨"
        
        echo "âœ… ë¦´ë¦¬ìŠ¤ ì¤€ë¹„ ì™„ë£Œ"

    - name: Create Release and Upload Assets
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ“¤ ë¦´ë¦¬ìŠ¤ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ ì¤‘..."
        
        # ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±
        if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
          echo "ğŸ—‘ï¸ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì‚­ì œ ì¤‘: ${TAG_NAME}"
          gh release delete "${TAG_NAME}" -y
        fi
        
        # ìƒˆ ë¦´ë¦¬ìŠ¤ ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ
        echo "ğŸ“¤ ìƒˆ ë¦´ë¦¬ìŠ¤ ìƒì„± ë° PDF íŒŒì¼ ì—…ë¡œë“œ ì¤‘..."
        gh release create "${TAG_NAME}" \
          --title "BioStar 2 Release Notes v${{ github.event.inputs.version }}" \
          --notes "Suprema BioStar 2 Release Notes v${{ github.event.inputs.version }} (Generated: $(date '+%Y-%m-%d %H:%M:%S'))" \
          "./pdf/${KO_NAME}.pdf" \
          "./pdf/${EN_NAME}.pdf"
        
        echo "âœ… ë¦´ë¦¬ìŠ¤ ìƒì„± ë° ì—…ë¡œë“œ ì™„ë£Œ"